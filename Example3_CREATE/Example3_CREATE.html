<!DOCTYPE html>
<html>
  <head>
   <link href='bootstrap.min.css' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
   <style>		
		.agent-container { width: 800px; display: block; margin-left: auto; margin-right: auto;}
		.control-container { width: 800px; display: block; margin-left: auto; margin-right: auto;}
		#fetch-agent-issue { display: none; }
	</style>
  
  
  <script>
	var CCAURL = 'http://ns7.askia.com:80/ccawebapi/';
	var token;
	var defaultAgentObj;
	
	//this function is a helper to convert a JSON object into a Form data, so that its treated as Form Data in the HTTP POST, rather than Payload.
	function buildFormBody(obj) {
		var form = [];
		for (var key in obj) {
			if (obj.hasOwnProperty(key)) {
				if (typeof obj[key])
				form.push(encodeURIComponent(key) + "=" + encodeURIComponent(obj[key]));
			}
		}
		return form.join("&");
	}
	
	function init(){
		document.getElementById('doc').innerHTML = CCAURL;
		document.getElementById('doc').setAttribute("href",CCAURL);
		authenticate();
	}
	
	function authenticate(){
		fetch( CCAURL + 'session', {
			method:'post',
			headers:{
				"Content-Type": "text/json"
			},
			body: JSON.stringify({ 
				username : "Supervisor",
				password : "Supervisor",
				module   : "RecordingManagementTool",
			})
		})
		.then(function( response ) {
			if(response.ok){
				return response.json().then(function(json){
					token=json.Response.Token;
					//further proceed with Token
					
					//document.getElementById('result').innerHTML = "Status : " + response.status + "<br>" + "Status text : " + response.statusText + "<br>" + "Current Authenticity token : " + token;
				});
			}
			else{
				//document.getElementById('result').innerHTML = "Status : " + response.status + "<br>" + "Status text : " + response.statusText;
			}
		});
	}

    function getAgentJSON(){
		fetch('http://ns7.askia.com:80/ccawebapi/Agents/0',
			{
			headers: {'Authorization': 'Basic ' + token}
			}
		)
		.then(function(response){
			return response.json().then(function(json){
				if (json.StatusCode === 200) {
					document.getElementById("fetch-agent-issue").style["display"] = 'none';
					defaultAgentObj = json.Response;
					
					['UserName', 'Name', 'LastName'].forEach(function(element){
						document.getElementById('input' + element).value = json.Response[element];
					});
					
					document.getElementById('RecordAllCalls').checked = json.Response['RecordAllCalls'];
					document.getElementById('RecordAllCallsInStereo').checked = json.Response['RecordAllCallsInStereo'];
					
				} else {
					// Show the user a Warning that something went wrong with the API
					document.getElementById("fetch-agent-issue").style["display"] = 'block';
				}
			})
		})
   }
   
   function setAgentJSON(){
		var newAgent = defaultAgentObj;
		newAgent['UserName'] = document.getElementById('input' + 'UserName').value;
		newAgent['Name'] = document.getElementById('input' + 'Name').value;
		newAgent['LastName'] = document.getElementById('input' + 'LastName').value;
		newAgent['RecordAllCalls'] = document.getElementById('RecordAllCalls').checked;
		newAgent['RecordAllCallsInStereo'] = document.getElementById('RecordAllCallsInStereo').checked;
		
		fetch('http://ns7.askia.com:80/ccawebapi/Agents',
		{
			headers: 
			{
				'Authorization': 'Basic ' + token,
				"Content-Type": "text/json"
			},
			method:'post',
			body: JSON.stringify(newAgent)
		})
		.then(function(response){
			return response.json().then(function(json){
				if (json.StatusCode === 200) {
					console.log("Agent created")
				} else {
					console.error("Could not create Agent");
				}
				console.log(json);
			})
		})
   }
   
   </script>
	</head>

  <body onload="init()">
	<div class="well control-container">
	<div class="alert alert-error" id="fetch-agent-issue">Something went wrong fetching the default agent</div>
	<h1>Example 3 : Creation</h1>
	<h2>Documentation about this API can be found at: <a id="doc" href=""></a></h2>
	<input type="button" class="btn" value="Get Agent/0 - Load Default Agent" onclick="getAgentJSON()"/>
	<br />
	<input type="button" class="btn" value="Post - Create New Agent" onclick="setAgentJSON()"/>
	</div>

	<div class="well agent-container">
		<div class="form-horizontal">
		  <div class="control-group">
			<label class="control-label" for="inputUserName">UserName</label>
			<div class="controls">
			  <input type="text" id="inputUserName" placeholder="User Name">
			</div>
		  </div>
		  <div class="control-group">
			<label class="control-label" for="inputName">Surname</label>
			<div class="controls">
			  <input type="text" id="inputName" placeholder="Surname">
			</div>
		  </div>
		  <div class="control-group">
			<label class="control-label" for="inputLastName">Name</label>
			<div class="controls">
			  <input type="text" id="inputLastName" placeholder="Name">
			</div>
		  </div>
		  
		  <div class="control-group">
			<div class="controls">
			  <label class="checkbox">
				<input type="checkbox" id="RecordAllCalls" checked="true">Record Conversations
			  </label>
			  <label class="checkbox">
				<input type="checkbox" id="RecordAllCallsInStereo" checked="true">Record Conversations in Stereo
			  </label>
			  <button onclick="setAgentJSON()" class="btn">Create Users</button>
			</div>
		  </div>
		</div>
	</div>
  </body>
</html>